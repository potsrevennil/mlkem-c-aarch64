# SPDX-License-Identifier: Apache-2.0

name: Set Shell
description: Setup nix or custom shell for workflows

inputs:
  use-nix:
    description: Indicate whether to use nix or not
    default: 'true'
  nix-shell:
    description: Run in the specified Nix environment if exists
    default: 'ci'
  nix-cache:
    description: Determine whether to enable nix cache
    default: 'false'
  nix-verbose:
    description: Determine wether to suppress nix log or not
    default: 'false'
  custom_shell:
    description: The shell to use. Only relevant if no nix-shell specified
    default: 'bash'
  script:
    description: The script to be run in the nix shell
    required: false
  gh_token:
    description: Github access token to use
    required: true

runs:
  using: composite
  steps:
    - name: Setup nix
      uses: ./.github/actions/setup-nix
      if: ${{ inputs.use-nix == 'true' && (env.SHELL == '' || env.Nix_SHELL != inputs.nix-shell) }}
      with:
        devShell: ${{ inputs.nix-shell }}
        gh_token: ${{ inputs.gh_token }}
        verbose: ${{ inputs.nix-verbose }}
        cache: ${{ inputs.nix-cache }}
        script: ${{ inputs.script }}
    - name: Set custom shell
      shell: bash
      if: ${{ inputs.use-nix != 'true' && env.SHELL == '' }}
      run: |
          echo SHELL="${{ inputs.custom_shell }}" >> $GITHUB_ENV

          if [[ "${{ inputs.script }}" != '' ]]; then
            eval ${{ inputs.script }}
          fi
